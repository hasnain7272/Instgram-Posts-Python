name: Instagram Reel Auto Post

on:
  schedule:
    - cron: '0 12 * * *'   # 12 AM UTC
    - cron: '0 18 * * *'  # 6 PM UTC  
    - cron: '0 0 * * *'  # 12 PM UTC
  workflow_dispatch:
    inputs:
      niche:
        description: 'Reel niche (travel, food, fitness, etc.)'
        required: false
        default: 'fitness'
      num_images:
        description: 'Number of images in reel'
        required: false
        default: '5'
      duration:
        description: 'Total video duration in seconds (10-90)'
        required: false
        default: '10'

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: pip install google-generativeai requests pillow
      
      # - name: Download and install ffmpeg
      #   run: |
      #     mkdir -p $HOME/bin
      #     curl -L https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz -o ffmpeg.tar.xz
      #     tar -xf ffmpeg.tar.xz
      #     mv ffmpeg-*-amd64-static/ffmpeg $HOME/bin/
      #     echo "$HOME/bin" >> $GITHUB_PATH
      #     ffmpeg -version

      - name: Set Random Niche for Scheduled Runs
        if: github.event_name == 'schedule'
        id: random-niche
        run: |
          NICHES=("fitness" "travel" "food" "motivation" "tech" "wellness")
          echo "niche=${NICHES[$RANDOM % ${#NICHES[@]}]}" >> $GITHUB_OUTPUT
      
      - name: Generate and Post Reel
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_UPLOAD_PRESET: ${{ secrets.CLOUDINARY_UPLOAD_PRESET }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
          INSTAGRAM_ACCOUNT_ID: ${{ secrets.INSTAGRAM_ACCOUNT_ID }}
          INSTAGRAM_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
          REEL_NICHE: ${{ github.event.inputs.niche || 'travel' }}
          REEL_IMAGES: ${{ github.event.inputs.num_images || '20' }}
          REEL_DURATION: ${{ github.event.inputs.duration || '15' }}
        run: |
          python insta_reels_new.py

      - name: Success
        if: success()
        run: echo "✅ Reel posted successfully!"
    
      - name: Failure
        if: failure()
        run: echo "❌ Failed to post reel"
